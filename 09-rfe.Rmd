---
title: "09. Feature selection"
author: "Al Xin"
date: "1/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = F)
```

## Overview

Though RFE seems to not significantly drop the accuracy of the model (from
`08-rf.Rmd`), it is extremely time intensive. For workflow, it may be easier to
run RFE with a single model before testing the resulting variables on a variety
of model types.

Recursive feature elimination through caret will be implemented using the random
forest functions. The resulting top 10 variables will be used in model-building.
The `"rfe"` objects generated by caret will be saved in the directory `rfe/`.
The variables chosen will be saved in the directory `rfe_var/`.

The organization of `rfe/` will mirror that of `desc/`. The organization of
`rfe_var/` will not have subfolders for descriptor type; instead, each
descriptor type will be saved as a list in RDS form. E.g., the variables for all
Mordred descriptors will be saved as the RDS file `mordred.RDS`, which will
be a list with each element having the name of the data source.

```{r dir}
desc_src <- c("cdk", "mordred", "ochem", "padel")

if (!dir.exists("rfe")) {
  dir.create("rfe")
  dir_save <- lapply(paste0("rfe/", desc_src), dir.create)
}

if (!dir.exists("rfe_var")) dir.create("rfe_var")
```
## Dependencies

```{r dependencies}
library(caret)
library(qsarr)
library(parallel)
library(doParallel)
```

## Running recursive feature elimination

Using `caret::rfeControl()`, the recursive feature elimination will be composed of 10 repeats of 10-fold cross-validation. 

The data is read into a list of lists. In order to prevent an error from discarding progress, each element of the list will be saved independently. RFE also requires heavy computing resources, so parallel processing will be implemented with `parallel` and `doParallel`. 

```{r rfe}
# read data
desc_list <- lapply(
  paste0("preprocess/", desc_src), 
  function(x) {
    read_desc_list(list.files(x, full.names = T), quiet = T)
  }
)

names(desc_list) <- desc_src

rfe_ctrl <- rfeControl(
  functions = rfFuncs,
  method = "repeatedcv",
  repeats = 10, 
  number = 10
)

desc_name <- paste0(
  unlist(lapply(desc_src, rep, length(desc_list[[1]]))), 
  "/", rep(names(desc_list[[1]]), length(desc_list))
)
desc_list <- unlist(desc_list, recursive = F)
names(desc_list) <- desc_name

# Parallel processing setup
num_core <- detectCores()
# Subtracting 2 from total cores prevents R from using all system resources
if (num_core > 2) num_core <- num_core - 2

cl <- makeCluster(num_core)
registerDoParallel(cl)

set.seed(20210113)
desc_rfe <- lapply(
  desc_name, 
  function(x) {
    rfe_obj <- rfe(
      form = dG ~ . - guest,
      data = desc_list[[x]], 
      rfeControl = rfe_ctrl
    )
    saveRDS(rfe_obj, paste0("rfe/", x, ".RDS"))
  }
)
stopCluster(cl)
```

## Retrieving variables


