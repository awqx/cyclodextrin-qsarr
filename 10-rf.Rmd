---
title: "08. Random forest proof of concept"
author: "Al Xin"
date: "1/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

Models built on all predictor variables will be saved in `model/rf/all_var/`. 
Models trained on variables selected from RFE in 09 will be saved in `model/rf/rfe_var`. 

```{r directories}
desc_src <- c("cdk", "mordred", "ochem", "padel")

if (!dir.exists("model")) dir.create("model")
if (!dir.exists("model/rf")) {
  dir.create("model/rf")
  dir.create("model/rf/all_var")
  dir.create("model/rf/rfe_var")
  dir_create_result <- sapply(paste0("model/rf/all_var/", desc_src), dir.create)  
  dir_create_result <- sapply(paste0("model/rf/rfe_var/", desc_src), dir.create)  
}
```

### General outline for model building

## Dependencies

```{r package}
# library(caret)
library(dplyr)
# # library(stringr)
# library(tibble)
# library(tidyr)
library(qsarr)
# library(randomForest)
library(parallel)
library(doParallel)
```

## All variables

For creating models with all the variables, the descriptors are read as separate 
lists. This makes it clearer that different possible tuning parameters are used
based on the number of descriptors available. 

Previously in step 08 (random forest proof of concept), tuning yielded that 400
trees was sufficient for training. For a margin of error, 500 trees will be used.

```{r cdk_all}
# Read preprocessed descriptors
# Remove guest names for training
cdk_list <- read_desc_list(
  list.files("preprocess/cdk", full.names = T), 
  quiet = T
)

padel_list <- read_desc_list(
  list.files("preprocess/padel", full.names = T), 
  quiet = T
)

mordred_list <- read_desc_list(
  list.files("preprocess/mordred", full.names = T), 
  quiet = T
)

ochem_list <- read_desc_list(
  list.files("preprocess/ochem", full.names = T), 
  quiet = T
) 

data_name <- names(cdk_list)


# Parallel processing setup
num_core <- max(1, detectCores() - 1)
cl <- makeCluster(num_core)
registerDoParallel(cl)
cl_lib <- clusterEvalQ(cl, library("qsarr"))
# cl_lib <- clusterEvalQ(cl, library("tibble"))
# cl_lib <- clusterEvalQ(cl, library("randomForest"))
clusterSetRNGStream(cl = cl, 20210116)

# library(caret)
# library(dplyr)
# library(tibble)
# library(tidyr)
# library(qsarr)
# library(randomForest)
# library(parallel)
# library(doParallel)
# clusterExport(
#   cl = cl, 
#   varlist = c(
#     "tune", 
#     "tune.randomForest", 
#     "tune_helper",
#     "best_summary_stat", 
#     "eval_model", 
#     "eval_model_rep", 
#     "normalize_"
#   )
# )
cdk_all <- parLapply(
  cl = cl,
  cdk_list, 
  tune, 
  method = "rf", 
  resp = "dG",
  ignore_col = "guest",
  nfold = 10,
  nrep = 10,
  ntree = 500, 
  replace = c(T, F),
  mtry = c(4, 16, 32, 64), 
  nodesize = c(2, 4, 8)
)

cdk_all_save <- lapply(
  data_name, 
  function(x) {
    saveRDS(cdk_all[[x]], paste0("model/rf/all_var/cdk/", x, ".RDS"))
  }
)

padel_all <- parLapply(
  cl = cl,
  padel_list, 
  tune, 
  method = "rf", 
  resp = "dG",
  ignore_col = "guest",
  nfold = 10,
  nrep = 10,
  ntree = 500, 
  replace = c(T, F),
  mtry = c(4, 20, 40, 100), 
  nodesize = c(2, 4, 8)
)

padel_all_save <- lapply(
  data_name, 
  function(x) {
    saveRDS(padel_all[[x]], paste0("model/rf/all_var/padel/", x, ".RDS"))
  }
)

mordred_all <- parLapply(
  cl = cl,
  mordred_list, 
  tune, 
  method = "rf", 
  resp = "dG",
  ignore_col = "guest",
  nfold = 10,
  nrep = 10,
  ntree = 500, 
  replace = c(T, F),
  mtry = c(4, 20, 40, 100), 
  nodesize = c(2, 4, 8)
)

mordred_all_save <- lapply(
  data_name, 
  function(x) {
    saveRDS(mordred_all[[x]], paste0("model/rf/all_var/mordred/", x, ".RDS"))
  }
)

ochem_all <- parLapply(
  cl = cl,
  ochem_list, 
  tune, 
  method = "rf", 
  resp = "dG",
  ignore_col = "guest",
  nfold = 10,
  nrep = 10,
  ntree = 500, 
  replace = c(T, F),
  mtry = c(4, 20, 60, 150), 
  nodesize = c(2, 4, 8)
)

ochem_all_save <- lapply(
  data_name, 
  function(x) {
    saveRDS(ochem_all[[x]], paste0("model/rf/all_var/ochem/", x, ".RDS"))
  }
)

stopCluster(cl = cl)
```
```{r rfe}
# Read preprocessed descriptors
# Remove guest names for training
cdk_list_rfe <- read_desc_list(
  list.files("rfe/df/cdk", full.names = T), 
  quiet = T
)

padel_list_rfe <- read_desc_list(
  list.files("rfe/df/padel", full.names = T), 
  quiet = T
)

mordred_list_rfe <- read_desc_list(
  list.files("rfe/df/mordred", full.names = T), 
  quiet = T
)

ochem_list_rfe <- read_desc_list(
  list.files("rfe/df/ochem", full.names = T), 
  quiet = T
) 

data_name <- names(cdk_list_rfe)

set.seed(20210114)
cdk_rfe <- lapply(
  cdk_list_rfe, 
  tune, 
  method = "rf", 
  resp = "dG",
  ignore_col = "guest",
  nfold = 10,
  nrep = 10,
  ntree = 500,
  replace = c(T, F),
  mtry = c(2, 4, 8, 12),
  nodesize = c(2, 4, 8)
)

cdk_rfe_save <- lapply(
  data_name, 
  function(x) {
    saveRDS(cdk_rfe[[x]], paste0("model/rf/rfe_var/cdk/", x, ".RDS"))
  }
)


padel_rfe <- lapply(
  padel_list_rfe, 
  tune, 
  method = "rf", 
  resp = "dG",
  ignore_col = "guest",
  nfold = 10,
  nrep = 10,
  ntree = 500, 
  replace = c(T, F),
  mtry = c(2, 4, 8, 12), 
  nodesize = c(2, 4, 8)
)

padel_rfe_save <- lapply(
  data_name, 
  function(x) {
    saveRDS(padel_rfe[[x]], paste0("model/rf/rfe_var/padel/", x, ".RDS"))
  }
)


mordred_rfe <- lapply(
  mordred_list_rfe, 
  tune, 
  method = "rf", 
  resp = "dG",
  ignore_col = "guest",
  nfold = 10,
  nrep = 10,
  ntree = 500, 
  replace = c(T, F),
  mtry = c(2, 4, 8, 12), 
  nodesize = c(2, 4, 8)
)

mordred_rfe_save <- lapply(
  data_name, 
  function(x) {
    saveRDS(mordred_rfe[[x]], paste0("model/rf/rfe_var/mordred/", x, ".RDS"))
  }
)


ochem_rfe <- lapply(
  ochem_list_rfe, 
  tune, 
  method = "rf", 
  resp = "dG",
  ignore_col = "guest",
  nfold = 10,
  nrep = 10,
  ntree = 500, 
  replace = c(T, F),
  mtry = c(2, 4, 8, 12), 
  nodesize = c(2, 4, 8)
)

ochem_rfe_save <- lapply(
  data_name, 
  function(x) {
    saveRDS(ochem_rfe[[x]], paste0("model/rf/rfe_var/ochem/", x, ".RDS"))
  }
)
```

## External validation


